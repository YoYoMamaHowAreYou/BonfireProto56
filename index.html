<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Bonfire 🔥</title>
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#e17055">

<!-- Supabase & EmailJS -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
<script src="https://cdn.jsdelivr.net/npm/emailjs-com@2/dist/email.min.js"></script>

<!-- TensorFlow.js & Toxicity Model -->
<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/toxicity"></script>

<style>
/* --- Basic Reset & Layout --- */
* { box-sizing: border-box; }
body {
  margin: 0; font-family: 'Segoe UI', sans-serif;
  background: linear-gradient(135deg, #ffeaa7 0%, #fab1a0 25%, #fd79a8 50%, #fdcb6e 75%, #e17055 100%);
  background-size: 400% 400%; animation: gradientShift 15s ease infinite;
  color: #2d3436; min-height: 100vh; line-height: 1.6; padding-top: 70px;
}
@keyframes gradientShift { 0% {background-position:0% 50%;} 50% {background-position:100% 50%;} 100% {background-position:0% 50%;} }

header {
  position: fixed; top:0; width:100%; text-align:center; font-size:2rem;
  font-weight:600; color:#e17055; text-shadow:0 2px 4px rgba(0,0,0,0.1);
  background: rgba(255,255,255,0.9); backdrop-filter: blur(10px);
  padding:1rem 0; z-index:10; border-bottom:3px solid rgba(225,112,85,0.3);
}

#logout-btn {
  position: fixed; top:15px; right:15px; background:#d63031; color:white;
  padding:0.8rem 1rem; border:none; border-radius:8px; cursor:pointer; z-index:11;
}

.container {
  max-width: 650px; width: 90%; margin:2rem auto; padding:2rem;
  background: linear-gradient(145deg, rgba(255,255,255,0.95), rgba(255,255,255,0.9));
  backdrop-filter: blur(15px); border-radius:20px;
  box-shadow:0 8px 32px rgba(0,0,0,0.1), 0 2px 8px rgba(0,0,0,0.05);
  border:1px solid rgba(255,255,255,0.3); transition: all 0.3s ease;
}
.container.hidden { display:none; }

.chat-layout { display:flex; width:90%; max-width:1200px; margin:2rem auto; gap:1rem; }
#left-panel,#right-panel{ flex:1; min-width:180px; }
#center-panel{ flex:2; display:flex; flex-direction:column; }
.chat-box{ flex:1; min-height:300px; background:rgba(255,255,255,0.7); padding:1rem; border-radius:15px; overflow-y:auto; }
#mod-panel-bottom{ width:90%; max-width:1200px; margin:1rem auto; background:rgba(255,255,255,0.9); border-radius:10px; padding:1rem; display:none; }

.panel{ padding:1rem; border-radius:10px; background:rgba(255,255,255,0.85); margin-bottom:1rem; }
#happiness-bar-container{ width:100%; height:20px; background:#ddd; border-radius:10px; overflow:hidden; }
#happiness-bar{ height:100%; width:50%; background:orange; transition:width 0.3s, background 0.3s; }

#rules-panel ul { list-style: disc inside; max-height: 250px; overflow-y:auto; padding-left:0.5rem; }

input, button, textarea{ padding:0.8rem; margin:0.5rem 0; width:100%; border-radius:8px; border:1px solid #ccc; font-family:inherit; }
button{ background:#e17055; color:white; font-weight:600; cursor:pointer; border:none; }

@media (max-width:768px){
  .chat-layout{ flex-direction: column; }
  #left-panel,#center-panel,#right-panel{ width:100%; flex:unset; }
  #mod-panel-bottom{ width:100%; }
}
</style>
</head>
<body>
<header>Bonfire 🔥</header>
<button id="logout-btn" onclick="logout()">Logout</button>

<!-- Auth Container -->
<div class="container" id="auth">
  <h2>Login</h2>
  <input type="text" id="login-email" placeholder="Email">
  <input type="password" id="login-password" placeholder="Password">
  <button onclick="login()">Login</button>
  <p>or</p>
  <h2>Register</h2>
  <input type="text" id="reg-email" placeholder="Email">
  <input type="password" id="reg-password" placeholder="Password">
  <button onclick="register()">Register</button>
</div>

<!-- Chat Dashboard -->
<div class="container chat-layout hidden" id="chat">
  <div id="left-panel">
    <div id="happiness-panel" class="panel">
      <h2>😊 Happiness Meter</h2>
      <div id="happiness-bar-container"><div id="happiness-bar"></div></div>
      <p id="happiness-label">Neutral</p>
    </div>
  </div>
  <div id="center-panel">
    <div class="chat-box" id="chat-box"></div>
    <input type="text" id="message" placeholder="Type a message..." onkeydown="if(event.key==='Enter') sendMessage()">
    <button onclick="sendMessage()">Send</button>
  </div>
  <div id="right-panel">
    <div id="rules-panel" class="panel">
      <h2>📜 Community Rules</h2>
      <ul>
        <li>Be respectful to all members.</li>
        <li>No hate speech, racism, or discrimination.</li>
        <li>No spamming or flooding the chat.</li>
        <li>No sharing personal information.</li>
        <li>Use appropriate language; curse words are censored.</li>
        <li>Moderators' decisions are final.</li>
        <li>Follow instructions from moderators.</li>
        <li>No posting illegal content or links.</li>
        <li>Do not harass or bully other users.</li>
        <li>Enjoy and contribute positively to the community!</li>
      </ul>
    </div>
  </div>
</div>

<!-- Mod Panel Bottom -->
<div class="container" id="mod-panel-bottom">
  <h3>Moderator Panel</h3>
  <input type="text" id="ban-user" placeholder="User to ban">
  <button onclick="banUser()">Ban</button>
  <button onclick="showUsers()">Show Active Users</button>
  <ul id="user-list"></ul>
</div>

<script>
// ----------------- Setup -----------------
const supabase = window.supabase.createClient(
  'https://jledwbwxoepxfjqdqdna.supabase.co', // replace
  'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpsZWR3Ynd4b2VweGZqcWRxZG5hIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDc5MDA1NzgsImV4cCI6MjA2MzQ3NjU3OH0.PjYsS8Bi5--U2CwZzHJkoIKANXji9VZukYwgX6PTnRs' // replace
);

emailjs.init('kF8oBzDIb2iJYuHVs'); // replace

let currentUser = null;
const MOD_EMAILS = [
  "swarup.kadam17@gmail.com",
  "agarwalpahal15@gmail.com",
  "diya.thanuj@gmail.com"
];

const modAccounts = { 
  "swarup.kadam17@gmail.com": true,
  "agarwalpahal15@gmail.com": true,
  "diya.thanuj@gmail.com": true
};

// Example word lists
const happyWords = ["happy","joy","love","great","fun","cool","yay"];
const sadWords = ["sad","angry","hate","bad","upset"];
const curseWords = ["damn","shit","fuck","bitch","ass"]; // expand as needed

let toxicityModel = null;
async function loadModels() {
  toxicityModel = await toxicity.load(0.9);
  console.log("Toxicity model loaded!");
}
loadModels(); // load once on start

// ----------------- Functions -----------------
async function sendToxicityAlert(user, message) {
  const timestamp = new Date().toLocaleString();
  for (const modEmail of MOD_EMAILS) {
    await emailjs.send(
      'service_l7avq2v',     // replace
      'template_xfoxxw8',    // replace
      { to_email: modEmail, user_email: user, message_content: message, timestamp: timestamp }
    );
  }
}

function censorMessage(message) {
  let censored = message;
  curseWords.forEach(word => {
    const regex = new RegExp(`\\b${word}\\b`, "gi");
    censored = censored.replace(regex, '*'.repeat(word.length));
  });
  return censored;
}

function addMessage(text, system=false){
  const chatBox = document.getElementById('chat-box');
  const msgDiv = document.createElement('div');
  msgDiv.classList.add(system ? 'system-msg' : 'user-msg');
  msgDiv.textContent = text;
  chatBox.appendChild(msgDiv);
  chatBox.scrollTop = chatBox.scrollHeight;
  updateHappinessMeter();
}

function showChatLayout(){
  document.getElementById('auth').classList.add('hidden');
  document.getElementById('chat').classList.remove('hidden');
}

async function login(){
  const email = document.getElementById('login-email').value.trim();
  const password = document.getElementById('login-password').value.trim();
  if(!email || !password) return alert("Enter both email and password.");

  currentUser = email;
  showChatLayout();
  if(modAccounts[email]) document.getElementById('mod-panel-bottom').style.display='block';
  addMessage(`🟢 ${currentUser} has joined.`, true);
  await loadMessages();
}

async function register(){
  const email = document.getElementById('reg-email').value.trim();
  const password = document.getElementById('reg-password').value.trim();
  if(!email || !password) return alert("Enter both email and password.");

  currentUser = email;
  showChatLayout();
  if(modAccounts[email]) document.getElementById('mod-panel-bottom').style.display='block';
  addMessage(`🟢 ${currentUser} has joined.`, true);
  await loadMessages();
}

function logout(){
  currentUser=null;
  document.getElementById('auth').classList.remove('hidden');
  document.getElementById('chat').classList.add('hidden');
  document.getElementById('mod-panel-bottom').style.display='none';
  document.getElementById('chat-box').innerHTML='';
  document.getElementById('user-list').innerHTML='';
  document.getElementById('login-email').value='';
  document.getElementById('login-password').value='';
  document.getElementById('reg-email').value='';
  document.getElementById('reg-password').value='';
  document.getElementById('message').value='';
  document.getElementById('ban-user').value='';
}

async function sendMessage(){
  if(!currentUser) return;
  const rawMessage = document.getElementById('message').value.trim();
  if(!rawMessage) return;

  // Check ban
  const { data: bans } = await supabase.from('banned_users').select('email').eq('email', currentUser);
  if(bans.length>0){ alert("You're banned."); return; }

  // Toxicity detection
  if(toxicityModel){
    const predictions = await toxicityModel.classify([rawMessage]);
    const isToxic = predictions.some(pred => pred.results[0].match && pred.results[0].probabilities[1]>0.9);
    if(isToxic){
      addMessage(`⚠️ Toxic message detected from ${currentUser}`, true);
      await sendToxicityAlert(currentUser, rawMessage);
    }
  }

  // Censor message & store
  const message = censorMessage(rawMessage);
  await supabase.from('messages').insert([{ user: currentUser, message }]);
  document.getElementById('message').value='';
  addMessage(`${currentUser}: ${message}`);
}

async function loadMessages(){
  const { data } = await supabase.from('messages').select('*').order('id',{ascending:true});
  const chatBox = document.getElementById('chat-box'); chatBox.innerHTML='';
  data.forEach(msg => addMessage(`${msg.user}: ${msg.message}`));
}

async function banUser(){
  const userToBan = document.getElementById('ban-user').value.trim();
  if(!userToBan) return;
  await supabase.from('banned_users').insert([{ email:userToBan }]);
  addMessage(`⚠️ ${userToBan} has been banned by a moderator.`, true);
  alert(`${userToBan} has been banned.`);
}

async function showUsers(){
  const { data } = await supabase.from('users').select('email');
  const userList = document.getElementById('user-list'); userList.innerHTML='';
  data.forEach(user=>{ const li=document.createElement('li'); li.textContent=user.email; userList.appendChild(li); });
}

async function updateHappinessMeter(){
  const { data } = await supabase.from('messages').select('message');
  let happinessScore=0;
  data.forEach(({message})=>{
    const lower=message.toLowerCase();
    happyWords.forEach(w=>{ if(lower.includes(w)) happinessScore++; });
    sadWords.forEach(w=>{ if(lower.includes(w)) happinessScore--; });
    curseWords.forEach(w=>{ if(lower.includes(w)) happinessScore--; });
  });
  const meter = document.getElementById('happiness-bar');
  const normalizedScore=Math.min(Math.max((happinessScore+10)*5,0),100);
  meter.style.width=`${normalizedScore}%`;
  if(normalizedScore>66) meter.style.background='green';
  else if(normalizedScore>33) meter.style.background='orange';
  else meter.style.background='red';
  const label = document.getElementById('happiness-label');
  if(normalizedScore>66) label.textContent="😊 Happy";
  else if(normalizedScore>33) label.textContent="😐 Neutral";
  else label.textContent="😢 Sad";
}

// ----------------- Service Worker -----------------
if("serviceWorker" in navigator){
  navigator.serviceWorker.register("sw.js")
    .then(()=>console.log("Service Worker registered!"))
    .catch(err=>console.error("Service Worker failed:",err));
}
</script>
</body>
</html>
